<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<style>
  /* IMAGE STYLES */
  [type=radio]+div {
    cursor: pointer;
    transform: scale(5);
  }

  .pad-td {
    padding-right: 20px;
  }

  .face-img {
    width: 256px;
    max-width: 256px;
    padding: 4px
  }

  body {
    font-family: 'Google Sans', sans-serif;
    padding-bottom: 50px;
  }

  .instruction {
    font-size: 18px;
  }

  .title {
    font-size: 35px;
  }

  br.large {
    line-height: 22px;
  }

  .crit {
    background-color: #fff1f1;
    padding: 5px;
    margin: 5px;
  }

  table.result td {
    width: 256px;
    text-align: center;
    vertical-align: middle;
    padding: 5px;
    margin: 0px;
    /* margin-bottom: 10px; */
  }

  td {
    text-align: center;
  }

  .lighting-td {
    padding: 0px;
  }

  table {
    margin-left: auto;
    margin-right: auto;
    border-spacing: 0px;
  }

  .sticky-div {
    position: -webkit-sticky;
    /* For Safari */
    position: sticky;
    top: 0;
    /* Distance from the top */
    background-color: white;
  }

  .questiontext {
    font-size: 22px;
    text-align: center;
  }

  .qtext {
    font-size: 22px;
  }

  .firsttd {
    text-align: left !important;
    padding: 10px !important;
  }

  h1 {
    text-align: center;
  }

  .template,
  .tdtemplate,
  .tdtemplate2 {
    display: none;
  }

  .caption {
    font-size: 20px;
  }

  input[type="radio"],
  .choice {
    cursor: pointer;
  }

  input[type="radio"] {
    margin-top: 15px;
  }

  .caption {
    cursor: pointer;
  }

  label.caption {
    padding-top: 10px;
  }
</style>

<!-- <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet"> -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<!-- <form action="/submit" method="post"> -->
<crowd-form>

  <div style="background-color:azure; text-align:left; margin-left: auto; margin-right: auto; padding-left: 50px;"
    header="Instructions">
    <h2 class="title">Face Relighting Evaluation</h2>
    <span class="instruction">
      <p>This webpage contains 10 tasks, each with 2 questions (20 questions in total). </p>

      <p>In each task, you will assess which result most convincingly relights an input face image (A) to match a target
        lighting condition (B) and (C). The target lighting is illustrated using visual: </p>
      <ol class="instruction">
        <li>A rendering of a diffuse ball under the target lighting condition.</li>
      </ol>
      <p>
        In other words, you will determine which result has realistic cast shadow effects and consistent movement of
        cast shadows that aligns with the given target lighting in each row.
        Then, you will choose the most convincing result based on the criterion.</p>
      <p class="crit"><b>Criterion:</b> Consider the results that most convincingly demonstrate realistic relighting
        with cast shadow effects showing consistent and natural movement in response to lighting changes.</p>
      <br>
      To make a selection, click either on the video itself or the radio button below the video. Once done, please
      click 'Submit' at the bottom of this page.
      </p>
    </span>
  </div>
  <br>
  <hr><br>
  <div id="main">
    <div class="task template">
      <!-- <div class="sticky-div"> -->
      <h1>Task {num}</h1>
      <p class="questiontext">
        <!-- Which of these results most convincingly relights the input face image to match the target lighting? -->
        Which of these results most convincingly relights the input face image and produces cast shadow effects based on
        the given target lighting?
      </p>
      <!-- </div> -->
      <table class="result">
        <tr>
          <td></td>
          <td colspan="4">
            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/input_pair{p}.png" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/input_pair{p}.png" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/input_pair{p}.png" class="face-img"><br>
            <span class="caption">(A) Input Image</span> -->

            <img src="../dat/move_shadows_mturk/user_study_rotateSH_pairs/pair{p}/input_pair{p}.jpg"
              class="face-img"><br>
            <span class="caption">(A) Input Image</span>
            <div class="spacer" style="height: 7px;"></div>
          </td>
          <!-- <td style="" colspan="3"> -->
          <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

          <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

          <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

        </tr>
        <tr style="background-color: #EEEEEE;">
          <td class="firsttd"><span class="qtext">Question {q1}:</span><br> Considering results relit with <em>target
              lighting (B)</td>

          <td style="" colspan="1">
            <video src="../dat/move_shadows_mturk/user_study_rotateSH_pairs/pair{p}/sh_pair{p}_axis1.mp4" class="fg-img"
              muted autoplay loop></video><br>
            <div style="height: 10px;"></div>
            <span class="caption">(B) Target Lighting </span>
          </td>

          <td class="tdtemplate">

            <video src="../dat/move_shadows_mturk/user_study_rotateSH_pairs/pair{p}/{name}_pair{p}_axis1.mp4" autoplay
              loop muted onclick="this.nextElementSibling.click();" class="fg-img choice">
              Your browser does not support the video tag.
            </video>

            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_facial.png"
             onclick="this.nextElementSibling.click();" class="fg-img choice" /> -->
            <input type="radio" id="q{qnum}a{anum}" name="q{qnum}_p{p}" value="a{anum}_{name}" />
            <label for="q{qnum}a{anum}" class="caption choice">Result {anum}</label>
          </td>
        </tr>
        <tr>
          <td style="height: 10px;"></td>
        </tr>
        <tr style="background-color: #EEEEEE;">
          <td class="firsttd"><span class="qtext">Question {q2}:</span><br> Considering results relit with <em>target
              lighting (C)</em>
          </td>
          <td style="" colspan="1">
            <video src="../dat/move_shadows_mturk/user_study_rotateSH_pairs/pair{p}/sh_pair{p}_axis2.mp4" class="fg-img"
              muted autoplay loop></video><br>
            <div style="height: 10px;"></div>
            <span class="caption">(C) Target Lighting </span>
          </td>
          <td class="tdtemplate2">
            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->

            <!-- <img src="../dat/randomly_for_mturk/user_study_targetSH_pairs/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->

            <video src="../dat/move_shadows_mturk/user_study_rotateSH_pairs/pair{p}/{name}_pair{p}_axis2.mp4" autoplay
              loop muted onclick="this.nextElementSibling.click();" class="choice">
              Your browser does not support the video tag.
            </video>

            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->
            <input type="radio" id="q{qnum}a{anum}" name="q{qnum}_p{p}" value="a{anum}_{name}" />
            <label for="q{qnum}a{anum}" class="caption choice">Result {anum}</label>
          </td>
        </tr>
      </table>
      </table>
      <hr>
    </div>
  </div>
  <div style="text-align:center;width:100%" id="result-panel"></div>

  <script>

    const data = "${sj_name}";
    const vs = "${vs_name}";
    // let sj_mockup = "pair11#pair15#pair19#pair5#pair16#pair3#pair2#pair6#pair10#pair13"
    // let vs_mockup = "difareli++-vs-ic_light#difareli++-vs-ic_light#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom#difareli++-vs-ic_light#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom#difareli++-vs-ic_light#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom"
    let sj_mockup = "pair11#pair15#pair19"
    let vs_mockup = "difareli++-vs-ic_light#difareli++-vs-ic_light#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom"
    let sj_pairs = sj_mockup.split("#");
    var n = sj_pairs.length;
    let vs_pairs = vs_mockup.split("#");
    vs_pairs = vs_pairs.map(x => x.split("-vs-"));
    console.log("[#] PAIRS: " + sj_pairs);
    console.log("Length: " + sj_pairs.length);
    console.log("[#] VS: " + vs_pairs);
    console.log("Length: " + vs_pairs.length);
    // Get number from pair{num}
    let pair_id = sj_pairs.map(x => parseInt(x.replace("pair", "")));

    let counter = 0;
    for (let [i, pair_number] of pair_id.entries()) {
      var div = document.querySelector('.template').cloneNode(true);
      div.className = 'task';

      let tem = div.innerHTML;
      tem = tem.replace(/{num}/g, counter + 1);
      tem = tem.replace(/{p}/g, pair_number);
      tem = tem.replace(/{q1}/g, 2 * counter + 1);
      tem = tem.replace(/{q2}/g, 2 * counter + 2);
      div.innerHTML = tem;

      let listimages = vs_pairs[i];
      console.log("VS PAIR: " + vs_pairs);
      console.log("[#] LIST IMAGES: " + listimages);
      console.log("Val", pair_number)
      let n_choices = listimages.length;
      listimages = listimages.sort(() => Math.random() - 0.5);
      // Create listimages that shuffle for each question e.g., input ["difareli++", "ic_light"] => output [shuffled_input, shuffled_input]
      console.log("Original LIST IMAGES: " + listimages);
      listimages = [structuredClone(listimages), structuredClone(listimages)];
      console.log("Input LIST IMAGES: " + listimages);
      listimages = listimages.map(x => x.sort(() => Math.random() - 0.5));
      console.log("Shuffled LIST IMAGES: " + listimages);
      for (let j = 0; j < n_choices; j++) {
        function replace(templatename, q) {
          let template = div.querySelector('.' + templatename);
          let newtd = template.cloneNode(true);
          newtd.className = "";

          let str = newtd.innerHTML;
          str = str.replace(/{p}/g, pair_number);
          if (q % 2 == 0) {
            str = str.replace(/{name}/g, listimages[0][j]);
          } else {
            str = str.replace(/{name}/g, listimages[1][j]);
          }
          str = str.replace(/{qnum}/g, q);
          str = str.replace(/{anum}/g, j + 1);
          newtd.innerHTML = str;
          template.parentNode.appendChild(newtd);
        }

        replace("tdtemplate", 2 * counter + 1);
        replace("tdtemplate2", 2 * counter + 2);
      }
      counter++;

      document.getElementById('main').appendChild(div);
    }

    window.onload = function () {
      var radios = document.querySelectorAll('input[type="radio"]');
      console.log("[#] RADIOACTIVE : ");
      console.log(radios.length);
      for (var i = 0; i < radios.length; i++) {
        radios[i].addEventListener('click', function () {
          var images = this.parentNode.parentNode.querySelectorAll('video');
          for (var j = 0; j < images.length; j++) {
            images[j].style.outline = "none";
          }
          this.previousElementSibling.style.outline = "4px solid #f00";
        });
      }
    }

    document.querySelector('crowd-form').onsubmit = function (e) {
      // Check the results here
      checked = [];
      n_choices = 2
      // Available task
      for (var i = 0; i < n; i++) {
        // Available questions
        for (var j = 0; j < 2; j++) {
          // Available choices
          for (let k = 0; k < n_choices; k++) {
            // Get the radio value
            checked.push(document.getElementById(`q${2 * i + j + 1}a${k + 1}`).checked);
          }
        }
      }

      valid_ans = [];
      for (let i = 0; i < checked.length; i += n_choices) {
        valid_ans.push(checked.slice(i, (i + n_choices)).some(element => element === true));
      }

      final_valid_ans = valid_ans.every(element => element === true);

      if (!final_valid_ans) {
        alert("[#] Please answer all of the question before making a submission...")
        e.preventDefault();
      }
      else {
        alert("Thank you for your time...");
      }
    }
  </script>

</crowd-form>