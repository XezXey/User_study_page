<style>
/* HIDE RADIO */
/*
[type=radio] { 
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
/*

/* IMAGE STYLES */
[type=radio] + div {
  cursor: pointer;
}

/* CHECKED STYLES */
/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 287px;
}
/*

/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 528px;
}
*/
.pad-td {
    padding-right: 20px; /* Add some padding */
    /* Add any other custom styles you want */
}

.face-img {
  width: 256px;
  max-width: 256px;
  padding: 4px
}

/*
.face-table thead{
  font-size: 1.5rem;
}
*/
</style>

<form action="/submit" method="post">
   

  <div style="background-color:azure; text-align:center;" header="Instructions">
      <h2> For user study & research purposes only.</h2>
      <p style="font-size: 20px"> Please watch the instruction video below. </p>
      <video width="1280" height="720" controls muted autoplay>
        <source src="./instruction.mp4" type="video/mp4">
      Your browser does not support the video tag.
      </video>

  </div>
  <br><hr><br>
  <h2> [#] The questions are provided below. Please carefully consider all images and respond to all of them. </h2>
  <div style="text-align:center;width:100%" id="result-panel"></div>
  <script>
    var n = 5; // Set n to the desired number of elements
    var max_pairs = 300;
    var subjects = Array.from({ length: n }, () => `pair${Math.floor(Math.random() * max_pairs) + 1}`);
  	//var subjects = Array.from({ length: n }, (_, i) => `pair${i + 1}`);
    //var subjects = Array.from({ length: 100 }, (_, i) => `pair${0 + i}`);

    var questions = ["Most Accurate", "Most Realistic"]; // Add more questions as needed
    var questions_label = ["accuracy", "realism"];

    var result_panel = document.getElementById("result-panel");
    var output_html = ""

    //NOTE: Iterate over each subject
    subjects.forEach(sj_name => {
      var orders = ["difareli_canny=153to204", 
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      orders = orders.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
      orders = ["input"].concat(orders) // ['input'] are always the first element;
      console.log(orders)
      // NOTE: Multiple questions
      output_html += 
      `
      <table class="face-table" style="margin-left: auto;margin-right: auto;">
      <thead>
      </thead>
      `
      // Showing the input-target-sh
      const input_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/input_${sj_name}.png`;
      const target_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/target_${sj_name}.jpg`;
      const sh_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/sh_${sj_name}.jpg`;
      
      var source = [input_img_p, target_img_p, sh_img_p];
      var source_lab = ["Input Image", "Target Lighting", "Target SH"];
      var show_source = `<td colspan="${orders.length-1}" style="text-align: center;">`;  // Open the td tag
      
      for (let i = 0; i < 3; i++) {
        // Add each image and label wrapped in a div with display inline-block to make them appear in line
        show_source += `<div style="display: inline-block;">
                          <span style="font-size: 23px; display: block;">${source_lab[i]}</span>
                          <img src="${source[i]}" style="display: block;" class="face-img"/>
                        </div>`;
      }
      show_source += `</td>`; // Close the td tag
      output_html += `<tr>${show_source}</tr>`;
      output_html += `</table>`
      testing_scenario = ["Face region relighting", "Background relighting"];
      sc = ["#DBCC95", "#C3E2C2"] // Changing the background color of the section here!!!
      testing_scenario.forEach((scenario, sc_index) => {
        output_html += 
        `
        <table style="margin-left: auto;margin-right: auto; background-color: ${sc[sc_index]};">
          <tr><td><span style="font-size: 23px; font-weight: bold;">
            Scenario: ${testing_scenario[sc_index]}</span></td></tr>
        `
        //output_html += 
        //`
        //<table style="margin-left: auto;margin-right: auto;">
        //  <tr><td colspan=${orders.length}><span style="font-size: 23px; font-weight: bold;">
        //    Scenario: ${testing_scenario[sc_index]}</span></td></tr>
        //`

        output_html += `<tr>`; 
        for (let i = 0; i < orders.length; i++) {
            const method_name = orders[i];
            if (scenario === 'Face region relighting') {
              var img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}_nobg.png`;
            }
            else {
              var img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}_bg.png`;
            }

            if (method_name !== "input") {
                output_html += `<td style="text-align: center;">`;
                output_html += `
                          <span style="font-size: 23px; text-align: center;">Relit#${i}</span><br>
                          <img src="${img_tmp_path}" class="face-img"/>
                `;
                output_html += `</td>`;
            }
        }
        output_html += `</tr>`; 
        
        for (let q = 0; q < questions.length; q++) {
            output_html += `<tr>`; // Start the row before the loop to have all questions in the same row
            const question = questions[q];

            // Add a label for the question
            output_html += `<td colspan=${orders.length} style="text-align: center; font-size: 23px;">${question}:`;
            
            // Create the radio buttons for each question
            for (let i = 0; i < orders.length; i++) {
                const method_name = orders[i];
                if (method_name !== "input") {
                    output_html += `
                        <input type="radio" id="${method_name}_${scenario}_${question}_${sj_name}" name="${scenario}_${question}_${sj_name}" value="${method_name}">
                        <label for="${method_name}_${scenario}_${question}_${sj_name}">Relit#${i}</label>
                    `;
                }
            }

            // Close the cell for the question
            output_html += `</td></tr>`;
        }

        output_html += `</tr>`;
        output_html += `</table>`
      })

      // End of each subject
      output_html += '<hr>'
    })

    result_panel.innerHTML  = output_html;
  </script>

  <div style="text-align:center;width:100%">
    <h2>Please check you've answered all the question then click submit.</h2>
    <input style="font-size:24px" type="button" value="Submit" id="submitbutton" onclick="submitForm()"></input>
  </div>

  <script>
    function submitForm(event) {
      var orders = ["difareli_canny=153to204", 
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      var radios = document.querySelectorAll('input[type="radio"]');
      var checked = [];
      console.log("[#] ORDERS : ");
      console.log(orders.length)
      console.log("[#] RADIO : ");
      console.log(radios.length)
      for (var i = 0; i < radios.length; i++) {
        checked.push(radios[i].checked)
      }
      console.log("[#] CHECK STATUS : ");
      console.log(checked);
      console.log(checked.length);
      // Slice into 2
      const valid_ans = [];
      for (let i = 0; i < checked.length; i += (orders.length)) {
        valid_ans.push(checked.slice(i, (i + orders.length)));
      }
      console.log("[#] SLICE : ")
      console.log(valid_ans)
      
      // Check each radio
      final_valid_ans = []
      for (let i = 0; i < valid_ans.length; i++) {
        final_valid_ans.push(!valid_ans[i].every(element => element === false));
      }
      console.log("[#] Check each radio : ")
      console.log(final_valid_ans);
      final_valid_ans = final_valid_ans.every(element => element === true);
      console.log("[#] Final status : ")
      console.log(final_valid_ans);


      if (!final_valid_ans) {
        alert("[#] Please answer all of the question...")
      }

      else {
        var output = {};
        subjects.forEach(sj_name => {
          output[sj_name] = {};
          testing_scenario.forEach(scenario => {
            output[sj_name][scenario] = {};
            questions.forEach(question => {
              // Construct the name attribute for the radio group
              let radioGroupName = `${scenario}_${question}_${sj_name}`;
              let radioButton = document.querySelector(`input[name="${radioGroupName}"]:checked`);
              let ans = radioButton.value;
              output[sj_name][scenario][question] = ans;
            });
          });
        });

        console.log("FROM HTML : " + JSON.stringify(output));
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/submit", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
              var response = JSON.parse(this.responseText);
              console.log("Response received: " + response.message);
            }
          };
        xhr.send(JSON.stringify(output));
        var button = document.getElementById(`submitbutton`);
        button.style.backgroundColor = "transparent";
        button.style.borderRadius = "0";
        button.disabled = true;
        button.value = "Submitted"
        alert("[#] Submitted, Thank you for your time...");
      }
    }
  </script>
</form>