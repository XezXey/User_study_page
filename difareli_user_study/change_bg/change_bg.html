<style>
/* HIDE RADIO */
[type=radio] { 
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

/* IMAGE STYLES */
[type=radio] + div {
  cursor: pointer;
}

/* CHECKED STYLES */
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 287px;
}

/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 528px;
}
*/
.pad-td {
    padding-right: 20px; /* Add some padding */
    /* Add any other custom styles you want */
}

.face-img {
  width: 256px;
  max-width: 256px;
  padding: 4px
}

.face-vid {
  width: 256px;
  max-width: 256px;
  padding: 4px
}
.face-table thead{
  font-size: 1.5rem;
}
.empty-space {
    width: 256px;
    height: 256px;
    background-color: #ffffff; /* Optional: Set a background color for visualization */
    display: inline-block;
    padding: 4px;

}
</style>

<form action="/submit" method="post">

  <div style="background-color:azure" header="Instructions">
    <h3> For the user study & research purpose only.</h3>
    <p>Which of the two images best accomplishes the following task?: <b>
      Softening the cast shadows from the "Original Image" while maintaining image sharpness.</b></p>
    <p>Step by step guide : </p>
    <ol>
      <li> Look at the original image in the middle.</li>
      <li> Click on one of two on the side (Softening#1 or Softening#2) that you think is the best image that can soften the shadow out and still maintain the sharpness of the image </li>
      <li> Make sure your answer is already selected. It must appear the red border around your preferred image.</li>
      <li> Click the submit button </li>
    </ol>
  </div>
  <div style="text-align:center; width:100%;">
    <p>Which of the two images best accomplishes the following task?:  <b>
      Softening the cast shadows from the "Original Image" while maintaining image sharpness.</b> </p>
    <!-- <table class="face-table" style="margin-left: auto;margin-right: auto;">
    <thead>
      <tr>
        <td style="width: 256px;">Softening#1</td>
        <td style="width: 256px;">Original image</td>
        <td style="width: 256px;">Softening#2</td>
       </tr>
    </thead>
    </table> -->
  </div>
  <div style="text-align:center;width:100%" id="result-panel"></div>
  <script>
  	var subjects = Array.from({ length: 9 }, (_, i) => `pair${i + 1}`);
    var result_panel = document.getElementById("result-panel");
    var output_html = ""
    var counter = 1;
    subjects.forEach(sj_name => {
      var orders = ["difareli", 
                    //"difareli_canny=51to51", 
                    "difareli_canny=153to204", 
                    //"difareli_canny=51to255",
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      orders = orders.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
      orders = ["input"].concat(orders) // ['input'] are always the first element;
      console.log(orders)

      /*
      output_html += 
      `
      <table class="face-table" style="margin-left: auto;margin-right: auto;">
      <thead>
        <tr>
          <td style="width: 256px;">Original image#${counter}</td>
      `
      for (var i = 1; i < orders.length; i++) {
        output_html += `
            <td style="width: 256px;"> Relit#${i}</td>
        `
      }
      output_html += 
      `
        </tr>
      </thead>
      `
      // NOTE: Showing all images for each row
      orders.forEach(method_name => {
          img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}.png`
          if (method_name == "input") {
              output_html += '<td><img src="' + img_tmp_path + '" class="face-img"/>';
              //output_html += `<br><div class="empty-space"></div>`;
              output_html += `</td>`
          }
          else{
              // Old layout
              output_html += `<td>`
              output_html += `
                  <label><input type="radio" name="${sj_name}" value="${method_name}" required>
                    <div class="mint">
                      <img src="${img_tmp_path}" class="face-img"/>
                    </div>
                  </label>
              `;
              output_html += `</td>`
          }
      })*/

      // NOTE: Showing only 3 images for each row
      output_html += 
      `
      <table class="face-table" style="margin-left: auto;margin-right: auto;">
      <thead>
      </thead>
      <tr>
      `
      var n_col = 4;
      for (let i = 0; i < orders.length; i++) {
          const method_name = orders[i];
          const img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}.png`;

          if (method_name === "input") {
              output_html += '<td class="pad-td"><span style="font-size: 20px;">Original Image</span><br><img src="' + img_tmp_path + '" class="face-img"/>';
              output_html += `</td>`;
          } else {
              // Old layout
              output_html += `<td>`;
              output_html += `
                  <label><input type="radio" name="${sj_name}" value="${method_name}" required>
                      <div class="mint">
                          <span style="font-size: 20px;">Relit#${i}</span><br>
                          <img src="${img_tmp_path}" class="face-img"/>
                      </div>
                  </label>
              `;
              output_html += `</td>`;
          }
          if ((i + 1) % n_col === 0) {
              const target_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/target_${sj_name}.jpg`;
              output_html += `</tr>`;
              output_html += '<td class="pad-td"><span style="font-size: 20px;">Target lighting</span><br><img src="' + target_tmp_path + '" class="face-img"/>';
              output_html += `</td>`;
          }
      }

      output_html += `</table>`
      output_html += "Click on the <b>Best</b> image";
      output_html += '<hr>'
      counter++;
    })
    result_panel.innerHTML  = output_html;
  </script>
  <div style="text-align:center;width:100%">
    <h2>Please check you've answered all the question then click submit.</h2>
    <input style="font-size:24px" type="button" value="Submit" id="submitbutton" onclick="submitForm()"></input>
  </div>
  <script>
    function submitForm(event) {
      var orders = ["difareli", 
                    //"difareli_canny=51to51", 
                    "difareli_canny=153to204", 
                    //"difareli_canny=51to255",
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      var radios = document.querySelectorAll('input[type="radio"]');
      var checked = [];
      console.log("[#] ORDERS : ");
      console.log(orders.length)
      console.log("[#] RADIO : ");
      console.log(radios.length)
      for (var i = 0; i < radios.length; i++) {
        checked.push(radios[i].checked)
      }
      console.log("[#] CHECK STATUS : ");
      console.log(checked);
      console.log(checked.length);
      // Slice into 2
      const valid_ans = [];
      for (let i = 0; i < checked.length; i += (orders.length)) {
        valid_ans.push(checked.slice(i, (i + orders.length)));
      }
      console.log("[#] SLICE : ")
      console.log(valid_ans)
      
      // Check each radio
      final_valid_ans = []
      for (let i = 0; i < valid_ans.length; i++) {
        final_valid_ans.push(!valid_ans[i].every(element => element === false));
      }
      console.log("[#] Check each radio : ")
      console.log(final_valid_ans);
      final_valid_ans = final_valid_ans.every(element => element === true);
      console.log("[#] Final status : ")
      console.log(final_valid_ans);


      if (!final_valid_ans) {
        alert("[#] Please answer all of the question...")
      }

      else {
        var output = {};
        subjects.forEach(sj_name => {
          var ans = document.querySelector(`input[name=${sj_name}]:checked`).value;
          output[sj_name] = ans
        })

        console.log("FROM HTML : " + JSON.stringify(output));
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/submit", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
              var response = JSON.parse(this.responseText);
              console.log("Response received: " + response.message);
            }
          };
        xhr.send(JSON.stringify(output));
        var button = document.getElementById(`submitbutton`);
        button.style.backgroundColor = "transparent";
        button.style.borderRadius = "0";
        button.disabled = true;
        button.value = "Submitted"
        alert("[#] Submitted, Thank you for your time...");
      }
    }
  </script>
</form>