<style>
/* HIDE RADIO */
/*
[type=radio] { 
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
/*

/* IMAGE STYLES */
[type=radio] + div {
  cursor: pointer;
  transform: scale(5);
}

/* CHECKED STYLES */
/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 287px;
}
/*

/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 528px;
}
*/
.pad-td {
    padding-right: 20px; /* Add some padding */
    /* Add any other custom styles you want */
}

.face-img {
  width: 256px;
  max-width: 256px;
  padding: 4px
}

/*
.face-table thead{
  font-size: 1.5rem;
}
*/
body {
  font-family: 'Google Sans', sans-serif;

  padding-bottom: 50px;
}
</style>

<link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


<form action="/submit" method="post">
   


  <div style="background-color:azure; text-align:left; width:2000px; margin-left: auto; margin-right: auto;" header="Instructions">
      <h2 style="font-size:35px;">For user study & research purposes only.</h2>
      <p style="font-size:35px;">Question: Which image demonstrates a convincing relighting of the input to match the target image's lighting?</p>
      <ol style="font-size: 30px;">
        <li><strong>Understand Target Lighting:</strong> Examine the target lighting image to understand the expected light direction and intensity.</li>
        <li><strong>Review Unmarked Images:</strong> Assess the non-watermarked areas of each candidate image for changes in lighting.</li>
        <li><strong>Select Convincing Relight:</strong> Choose the image that most convincingly relights the input image to match the target lighting.</li>
        <li><strong>Confirm and Submit:</strong> Double-check your choice to ensure it is the best match, then click 'submit'.</li>
    </ol>

  <h2> [#] The questions are provided below. Please carefully consider all images and respond to all of them. </h2>
  </div>
  <br><hr><br>
  <div style="text-align:center;width:100%" id="result-panel"></div>
  <script>
    var n = 5; // Set n to the desired number of elements
    var max_pairs = 10;
    //var subjects = Array.from({ length: n }, () => `pair${Math.floor(Math.random() * max_pairs) + 1}`);
  	var subjects = Array.from({ length: n }, (_, i) => `pair${i + 1}`);
    //var subjects = Array.from({ length: 100 }, (_, i) => `pair${0 + i}`);

    var questions = ["Convincingness"]; // Add more questions as needed
    var questions_label = ["convincingness"];

    var result_panel = document.getElementById("result-panel");
    var output_html = ""

    //NOTE: Iterate over each subject
    subjects.forEach((sj_name, sj_idx) => {
      var orders = ["difareli_canny=153to204", 
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      orders = orders.map(value => ({ value, sort: Math.random() })).sort((a, b) => a.sort - b.sort).map(({ value }) => value);
      orders = ["input"].concat(orders) // ['input'] are always the first element;
      console.log(orders)

      output_html += 
      `
      <div style="text-align:center; width:1400px; margin-left: auto; margin-right: auto;">
      <h1 style="text-align:left;"> ${sj_idx+1}) Question ID: ${sj_name}</h1>
      <table class="face-table" style="margin-left: auto;margin-right: auto;">
      <thead>
      </thead>
      `
      // Showing the input-target-sh
      const input_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/input_${sj_name}.png`;
      const target_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/target_${sj_name}.jpg`;
      const sh_img_p = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/sh_${sj_name}.jpg`;
      
      var source = [input_img_p, target_img_p, sh_img_p];
      var source_lab = ["Input Image", "Target Lighting"];
      var show_source = ``;  // Open the td tag
      
      // Add each image and label wrapped in a div with display inline-block to make them appear in line
      show_source += `
        <td colspan="1" style="text-align: center; vertical-align: middle;">
          <div style="display: inline-block; vertical-align: middle;">
              <span style="font-size: 23px; display: block;">Input Image</span>
              <img src="${source[0]}" class="face-img" style="vertical-align: middle;"/>
          </div>
        </td>
        <td colspan="2" style="text-align: center; vertical-align: middle;">
          <div style="display: inline-block; vertical-align: middle;">
              <span style="font-size: 23px; display: block; text-align: center;">Target Lighting</span>
              <img src="${source[1]}" class="face-img" style="vertical-align: middle;"/>
              <img src="${source[2]}" class="face-img" style="vertical-align: middle;"/>
          </div>
        </td>
      `
      output_html += `<tr>${show_source}</tr>`;
      output_html += `</table>`

      testing_scenario = ["Facial relighting", "Non facial relighting"];
      sc = ["#DBCC95", "#C3E2C2"] // Changing the background color of the section here!!!
      testing_scenario.forEach((scenario, sc_index) => {
        // Showing full relit images first (Once per subject)
        if (sc_index === 0) {
          output_html += `<tr>`;
          for (let i = 0; i < orders.length; i++) {
              const method_name = orders[i];
              var img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}_bg.png`;
              if (method_name !== "input") {
                  output_html += `<td style="text-align: center;">`;
                  output_html += `
                            <img src="${img_tmp_path}" class="face-img"/>
                  `;
                  output_html += `</td>`;
              }
          }
          output_html += `</tr>`; 

        }

        output_html += 
        `
        <table style="margin-left: auto;margin-right: auto; background-color: ${sc[sc_index]};">
          <tr><td><span style="font-size: 23px; font-weight: bold;">
        `

        // Showing the relit images for each scenario
        output_html += `<tr>`; 
        for (let i = 0; i < orders.length; i++) {
            const method_name = orders[i];
            if (scenario === 'Facial relighting') {
              var img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}_wm_facial.png`;
            }
            else {
              var img_tmp_path = `./dat/randomly_for_mturk/eval_pairs/${sj_name}/${method_name}_${sj_name}_wm_bg.png`;
            }

            if (method_name !== "input") {
                output_html += `<td style="text-align: center;">`;
                output_html += `
                          <img src="${img_tmp_path}" class="face-img"/>
                `;
                output_html += `</td>`;
            }
        }
        output_html += `</tr>`; 
        
        for (let q = 0; q < questions.length; q++) {
            output_html += `<tr>`; // Start the row before the loop to have all questions in the same row
            const question = questions[q];

            // Add a label for the question
            <!-- output_html += `<td colspan=${orders.length} style="text-align: center; font-size: 23px;">${question}:`; -->
            
            // Create the radio buttons for each question
            for (let i = 0; i < orders.length; i++) {
                const method_name = orders[i];
                if (method_name !== "input") {
                    output_html += `
                    <td style="text-align: center; font-size: 30px">
                        <input type="radio" style="width: 20px; height: 20px;" id="${method_name}_${scenario}_${question}_${sj_name}" name="${scenario}_${question}_${sj_name}" value="${method_name}">
                        <label for="${method_name}_${scenario}_${question}_${sj_name}"></label>
                    </td>
                    `;
                }
            }

            // Close the cell for the question
            output_html += `</td></tr>`;
        }

        output_html += `</tr>`;
        output_html += `</table>`
      })

      // End of each subject
      output_html += '</div><hr>'
    })

    result_panel.innerHTML  = output_html;
  </script>

  <div style="text-align:center;width:100%">
    <h2>Please check you've answered all the question then click submit.</h2>
    <input style="font-size:24px" type="button" value="Submit" id="submitbutton" onclick="submitForm()"></input>
  </div>

  <script>
    function submitForm(event) {
      var orders = ["difareli_canny=153to204", 
                    "total_relighting",
                    "hou21_shadowm",
                    "hou22_geom",
                  ];
      var radios = document.querySelectorAll('input[type="radio"]');
      var checked = [];
      console.log("[#] ORDERS : ");
      console.log(orders.length)
      console.log("[#] RADIO : ");
      console.log(radios.length)
      for (var i = 0; i < radios.length; i++) {
        checked.push(radios[i].checked)
      }
      console.log("[#] CHECK STATUS : ");
      console.log(checked);
      console.log(checked.length);
      // Slice into 2
      const valid_ans = [];
      for (let i = 0; i < checked.length; i += (orders.length)) {
        valid_ans.push(checked.slice(i, (i + orders.length)));
      }
      console.log("[#] SLICE : ")
      console.log(valid_ans)
      
      // Check each radio
      final_valid_ans = []
      for (let i = 0; i < valid_ans.length; i++) {
        final_valid_ans.push(!valid_ans[i].every(element => element === false));
      }
      console.log("[#] Check each radio : ")
      console.log(final_valid_ans);
      final_valid_ans = final_valid_ans.every(element => element === true);
      console.log("[#] Final status : ")
      console.log(final_valid_ans);


      if (!final_valid_ans) {
        alert("[#] Please answer all of the question...")
      }

      else {
        var output = {};
        subjects.forEach(sj_name => {
          output[sj_name] = {};
          testing_scenario.forEach(scenario => {
            output[sj_name][scenario] = {};
            questions.forEach(question => {
              // Construct the name attribute for the radio group
              let radioGroupName = `${scenario}_${question}_${sj_name}`;
              let radioButton = document.querySelector(`input[name="${radioGroupName}"]:checked`);
              let ans = radioButton.value;
              output[sj_name][scenario][question] = ans;
            });
          });
        });

        console.log("FROM HTML : " + JSON.stringify(output));
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/submit", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onreadystatechange = function() {
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
              var response = JSON.parse(this.responseText);
              console.log("Response received: " + response.message);
            }
          };
        xhr.send(JSON.stringify(output));
        var button = document.getElementById(`submitbutton`);
        button.style.backgroundColor = "transparent";
        button.style.borderRadius = "0";
        button.disabled = true;
        button.value = "Submitted"
        alert("[#] Submitted, Thank you for your time...");
      }
    }
  </script>
</form>