<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<style>
  /* HIDE RADIO */
  /*
[type=radio] { 
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
/*

/* IMAGE STYLES */
  [type=radio]+div {
    cursor: pointer;
    transform: scale(5);
  }

  /* CHECKED STYLES */
  /*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 287px;
}
/*

/*
[type=radio]:checked + div {
  outline: 3px solid #f00;
  height: 528px;
}
*/
  .pad-td {
    padding-right: 20px;
    /* Add some padding */
    /* Add any other custom styles you want */
  }

  .face-img {
    width: 256px;
    max-width: 256px;
    padding: 4px
  }

  /*
.face-table thead{
  font-size: 1.5rem;
}
*/
  body {
    font-family: 'Google Sans', sans-serif;
    padding-bottom: 50px;
  }

  .instruction {
    font-size: 18px;
  }

  .title {
    font-size: 35px;
  }

  br.large {
    line-height: 22px;
  }

  .crit {
    background-color: #fff1f1;
    padding: 5px;
    margin: 5px;
  }

  table.result td {
    width: 256px;
    text-align: center;
    vertical-align: middle;
    padding: 15px 15px;
    margin: 0px;
    /* margin-bottom: 10px; */
  }

  table.input-target td {
    width: 256px;
    text-align: center;
    vertical-align: middle;
    padding: 5px;
    margin: 0px;
    /* margin-bottom: 10px; */
  }

  td {
    text-align: center;
  }

  table {
    margin-left: auto;
    margin-right: auto;
    border-spacing: 0px;
  }

  .sticky-div {
    position: -webkit-sticky;
    /* For Safari */
    position: sticky;
    top: 0;
    /* Distance from the top */
    background-color: white;
  }

  .questiontext {
    font-size: 22px;
    text-align: center;
  }

  .qtext {
    font-size: 22px;
  }

  .firsttd {
    text-align: left !important;
    padding: 10px !important;
  }

  h1 {
    text-align: center;
  }

  .template,
  .tdtemplate,
  .tdtemplate2 {
    display: none;
  }

  .caption {
    font-size: 20px;
  }

  input[type="radio"],
  .choice {
    cursor: pointer;
  }

  input[type="radio"] {
    margin-top: 15px;
  }

  .caption {
    cursor: pointer;
  }

  label.caption {
    padding-top: 10px;
  }
</style>

<!-- <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet"> -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<!-- <form action="/submit" method="post"> -->
<crowd-form>

  <div style="background-color:azure; text-align:left; margin-left: auto; margin-right: auto; padding-left: 50px;" header="Instructions">
    <h2 class="title">Face Relighting Evaluation</h2>
    <span class="instruction">
      <p>This study has 10 tasks, each with 2 questions (20 total). </p>

      <p>For each task, look at the input face image (A) and the target lighting, shown by another person and a diffuse ball under that lighting. Choose the result that makes the input person look naturally relit, with lighting and shadows consistent with the target lighting, based on:

      <p class="crit"><b>Criterion 1:</b> Only the face.</p>
      <p class="crit"><b>Criterion 2:</b> The entire person (face, hair, body, and clothing), <em>excluding
          the background</em>.</p>
      <p><b>Important:</b> Always consider how well the relit faceâ€™s identity is preserved when making your choice.</p>
      <p>

      <b>To answer:</b>
      Click on the image or the radio button under it to select your choice. When finished with all questions, click 'Submit' at the bottom of this page.
      </p>
    </span>
  </div>
  <br>
  <hr><br>
  <div id="main">
    <div class="task template">
      <!-- <div class="sticky-div"> -->
      <h1>Task {num}</h1>
      <p class="questiontext">
        Which of these results most convincingly relights the input face image to match the target lighting?
      </p>
      <!-- </div> -->
      <table class="input-target">
        <tr>
          <!-- <td></td> -->
          <td style="padding-top: 1px;">
            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/input_pair{p}.png" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/input_pair{p}.png" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/input_pair{p}.png" class="face-img"><br>
            <span class="caption">(A) Input Image</span> -->

            <img style="padding-bottom:7px;margin-top:2px;" src="https://raw.githubusercontent.com/XezXey/User_study_page/refs/heads/main/difareli_user_study/DiFaReli%2B%2B_MajorRevision/dat/targetSH_mturk/user_study_targetSH_pairs_prepared_MajorRevision/pair{p}/input_pair{p}.jpg" class="face-img"><br>
            <span class="caption">(A) Input Image</span>
          </td>
          <td colspan="2" style="width: 533px;">
            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/sh_pair{p}.jpg" class="face-img"><br> -->

            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/refs/heads/main/difareli_user_study/DiFaReli%2B%2B_MajorRevision/dat/targetSH_mturk/user_study_targetSH_pairs_prepared_MajorRevision/pair{p}/target_pair{p}.jpg" class="face-img">
            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/refs/heads/main/difareli_user_study/DiFaReli%2B%2B_MajorRevision/dat/targetSH_mturk/user_study_targetSH_pairs_prepared_MajorRevision/pair{p}/sh_pair{p}.jpg" class="face-img">
            <!-- <br> -->
            <span class="caption">(B) Target Lighting</span>
          </td>
        </tr>
      </table>
      <table class="result">
        <tr style="background-color: #EEEEEE;">
          <td class="firsttd"><span class="qtext">Question {q1}:</span><br> Considering only the face region</td>
          <td class="tdtemplate">
            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_facial.png"
             onclick="this.nextElementSibling.click();" class="fg-img choice" /> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/{name}_pair{p}_wm_facial.png"
             onclick="this.nextElementSibling.click();" class="fg-img choice" /> -->

            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/refs/heads/main/difareli_user_study/DiFaReli%2B%2B_MajorRevision/dat/targetSH_mturk/user_study_targetSH_pairs_prepared_MajorRevision/pair{p}/{name}_pair{p}_wm_facial.png"
             onclick="this.nextElementSibling.click();" class="fg-img choice" />

            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_facial.png"
             onclick="this.nextElementSibling.click();" class="fg-img choice" /> -->
            <input type="radio" id="q{qnum}a{anum}" name="q{qnum}_p{p}" value="a{anum}_{name}" />
            <label for="q{qnum}a{anum}" class="caption choice">Result {anum}</label>
          </td>
        </tr>
        <tr>
          <td style="height: 10px;"></td>
        </tr>
        <tr style="background-color: #EEEEEE;">
          <td class="firsttd"><span class="qtext">Question {q2}:</span><br> Considering the entire person (face, hair,
            body, and clothing), <em>excluding
              the background</em>
          </td>
          <td class="tdtemplate2">
            <!-- <img src="./dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->

            <!-- <img src="./dat/randomly_for_mturk/pairs_for_ui_figure/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->

            <img src="https://raw.githubusercontent.com/XezXey/User_study_page/refs/heads/main/difareli_user_study/DiFaReli%2B%2B_MajorRevision/dat/targetSH_mturk/user_study_targetSH_pairs_prepared_MajorRevision/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/>

            <!-- <img src="https://raw.githubusercontent.com/XezXey/User_study_page/main/difareli_user_study/change_bg/dat/randomly_for_mturk/eval_pairs/pair{p}/{name}_pair{p}_wm_bg.png" 
            onclick="this.nextElementSibling.click();" class="bg-img choice"/> -->
            <input type="radio" id="q{qnum}a{anum}" name="q{qnum}_p{p}" value="a{anum}_{name}" /> 
            <label for="q{qnum}a{anum}" class="caption choice">Result {anum}</label>
          </td>
        </tr>
      </table>
      </table>
      <hr>
    </div>
  </div>
  <div style="text-align:center;width:100%" id="result-panel"></div>

  <script>
    const sj_data = "${sj_name}";
    const vs_data = "${vs_name}";
    let sj_pairs = sj_data.split("#");
    let vs_pairs = vs_data.split("#");

    // let sj_mockup = "pair18#pair91#pair95#pair87#pair64#pair6#pair39#pair15#pair41#pair48"
    //let vs_mockup = "difareli++-vs-relipa#difareli++-vs-hou21_shadowm#difareli++-vs-relipa#difareli++-vs-total_relighting#difareli++-vs-total_relighting#difareli++-vs-relipa#difareli++-vs-ic_light#difareli++-vs-ic_light#difareli++-vs-total_relighting#difareli++-vs-ic_light"
    // let sj_mockup = "pair80#pair55#pair46#pair81#pair19#pair17#pair99#pair77#pair84#pair8"
    // let vs_mockup = "difareli++-vs-relipa#difareli++-vs-hou22_geom#difareli++-vs-relipa#difareli++-vs-relipa#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom#difareli++-vs-hou21_shadowm#difareli++-vs-hou22_geom#difareli++-vs-diffusionrig#difareli++-vs-diffusionrig"
    // let sj_pairs = sj_mockup.split("#");
    // let vs_pairs = vs_mockup.split("#");
    var n = sj_pairs.length;
    vs_pairs = vs_pairs.map(x => x.split("-vs-"));
    console.log("[#] PAIRS: " + sj_pairs);
    console.log("Length: " + sj_pairs.length);
    console.log("[#] VS: " + vs_pairs);
    console.log("Length: " + vs_pairs.length);
    // Get number from pair{num}

    let pair_id = sj_pairs.map(x => parseInt(x.replace("pair", "")));

    let counter = 0;
    for (let [i, pair_number] of pair_id.entries()) {
      var div = document.querySelector('.template').cloneNode(true);
      div.className = 'task';

      let tem = div.innerHTML;
      tem = tem.replace(/{num}/g, counter + 1);
      tem = tem.replace(/{p}/g, pair_number);
      tem = tem.replace(/{q1}/g, 2 * counter + 1);
      tem = tem.replace(/{q2}/g, 2 * counter + 2);
      div.innerHTML = tem;

      let listimages = vs_pairs[i];
      console.log("VS PAIR: " + vs_pairs);
      console.log("[#] LIST IMAGES: " + listimages);
      console.log("Val", pair_number)
      let n_choices = listimages.length;
      listimages = listimages.sort(() => Math.random() - 0.5);
      // Create listimages that shuffle for each question e.g., input ["difareli++", "ic_light"] => output [shuffled_input, shuffled_input]
      console.log("Original LIST IMAGES: " + listimages);
      listimages = [structuredClone(listimages), structuredClone(listimages)];
      console.log("Input LIST IMAGES: " + listimages);
      listimages = listimages.map(x => x.sort(() => Math.random() - 0.5));
      console.log("Shuffled LIST IMAGES: " + listimages);
      for (let j = 0; j < n_choices; j++) {
        function replace(templatename, q) {
          let template = div.querySelector('.' + templatename);
          let newtd = template.cloneNode(true);
          newtd.className = "";

          let str = newtd.innerHTML;
          str = str.replace(/{p}/g, pair_number);
          if (q % 2 == 0) {
            str = str.replace(/{name}/g, listimages[0][j]);
          } else {
            str = str.replace(/{name}/g, listimages[1][j]);
          }
          str = str.replace(/{qnum}/g, q);
          str = str.replace(/{anum}/g, j + 1);
          newtd.innerHTML = str;
          template.parentNode.appendChild(newtd);
        }

        replace("tdtemplate", 2 * counter + 1);
        replace("tdtemplate2", 2 * counter + 2);
      }
      counter++;

      document.getElementById('main').appendChild(div);
    }

    window.onload = function () {
      var radios = document.querySelectorAll('input[type="radio"]');
      console.log("[#] RADIOACTIVE : ");
      console.log(radios.length);
      for (var i = 0; i < radios.length; i++) {
        radios[i].addEventListener('click', function () {
          var images = this.parentNode.parentNode.querySelectorAll('img');
          for (var j = 0; j < images.length; j++) {
            images[j].style.outline = "none";
          }
          this.previousElementSibling.style.outline = "4px solid #f00";
        });
      }
    }

    document.querySelector('crowd-form').onsubmit = function(e) {
      // Check the results here
      checked = [];
      n_choices = 2;  // Available choices
      // Available task
      for (var i = 0; i < n; i++) {
        // Available questions
        for (var j = 0; j < 2; j++){
          // Available choices
          for (let k = 0; k < n_choices; k++) {
            // Get the radio value
            checked.push(document.getElementById(`q${2*i+j+1}a${k+1}`).checked);
          }
        }
      }
      console.log("CK: " + checked);

      valid_ans = [];
      for (let i = 0; i < checked.length; i += n_choices) {
        valid_ans.push(checked.slice(i, (i + n_choices)).some(element => element === true));
      }

      final_valid_ans = valid_ans.every(element => element === true);
      
      if (!final_valid_ans) {
        alert("[#] Please answer all of the question before making a submission...")
        e.preventDefault();
      }
      else {
        alert("Thank you for your time...");
      }
  }
  </script>

  <script>
  </script>
</crowd-form>
